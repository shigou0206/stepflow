# InMemoryEventBus 优化与测试 Checklist

本清单用于系统性测试与优化事件总线（InMemoryEventBus）实现的鲁棒性与扩展性。

---

## ✅ 基本功能验证

| 序号 | 检查项 | 描述 | 优先级 |
|------|--------|------|--------|
| 1 | 多订阅者支持验证 | 同一个事件类型的多个 handler 是否都能收到事件 | ⭐⭐⭐⭐⭐ |
| 2 | 异常隔离 | 某个 handler 抛出异常，不影响其他 handler 与 dispatcher | ⭐⭐⭐⭐⭐ |
| 3 | `event_id` 自增隔离 | 每个 `run_id` 的事件序号独立递增，避免跨实例污染 | ⭐⭐⭐⭐ |

---

## ⚙️ 系统稳定性与管理

| 序号 | 检查项 | 描述 | 优先级 |
|------|--------|------|--------|
| 4 | dispatcher 启动检查 | `start()` 被重复调用是否能正确处理（忽略或报错） | ⭐⭐⭐ |
| 5 | graceful shutdown | `shutdown()` 正确处理未完成任务，避免 loop 报错 | ⭐⭐⭐⭐ |
| 6 | 等待队列耗尽 | shutdown 时加入 `await queue.join()`，确保事件全部消费 | ⭐⭐⭐⭐ |

---

## 🛠️ API 扩展能力

| 序号 | 检查项 | 描述 | 优先级 |
|------|--------|------|--------|
| 7 | `unsubscribe()` 方法 | 支持热插拔 handler，增强灵活性 | ⭐⭐⭐ |
| 8 | `clear()` 方法 | 测试/场景重置时清空所有 handler 和事件日志 | ⭐⭐ |
| 13 | `publish_sync()` | 用于非异步上下文测试或简化本地调试 | ⭐⭐ |
| 14 | 支持通配符订阅 | 如订阅 `*` 表示接收所有类型事件 | ⭐⭐ |

---

## 🔍 行为一致性验证

| 序号 | 检查项 | 描述 | 优先级 |
|------|--------|------|--------|
| 9 | 所有 EventType 全覆盖测试 | 每个事件类型都应能触发并携带正确字段 | ⭐⭐⭐⭐ |
| 10 | 异常 handler 不阻断 | 抛异常的 handler 不应阻止其他 handler 执行 | ⭐⭐⭐⭐⭐ |
| 11 | 队列满时回压测试 | 模拟大规模事件，验证是否会无限积压或丢弃 | ⭐⭐ |
| 12 | 事件顺序 | 同一 `run_id` 下事件是否按预期顺序传递 | ⭐⭐⭐ |

---

## ✅ 建议优先顺序

1. ✅ 多订阅者验证 / 异常隔离 / 顺序性
2. ✅ `event_id` 隔离与 dispatcher 启停行为
3. ✅ graceful shutdown + 队列 drain
4. 🛠️ 扩展接口（如 unsubscribe, clear）
5. 🔄 高压场景压测与通配符订阅支持

---
